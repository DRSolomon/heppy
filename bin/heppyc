#!/usr/bin/env python

# Message queue RPC version based on RabbitMQ and pika.

from pprint import pprint

from heppy.Args import Args
from heppy.Error import Error
from heppy.Client import Client
from heppy.Config import Config
from heppy.Request import Request
from heppy.Response import Response
from heppy.RabbitMQ import RPCClient

args = Args()
config = Config(args.get('path'))
request = Request.buildFromArgs(args)
query = str(request)
print Request.prettifyxml(query)

rabbit_config = config.get('RabbitMQ', {})
client = RPCClient(
    rabbit_config.get('host', 'localhost'),
    rabbit_config.get('queue', config['name'])
)

reply = client.request(query)
print Request.prettifyxml(reply)
response = Response.parsexml(reply)
pprint(response.data)

